<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>åˆ°è²¨é»è²¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 12px; }
    .item { border-bottom: 1px solid #ddd; padding: 8px 0; }
    input[type=number] { width: 60px; }
    button { margin-top: 12px; padding: 10px; width: 100%; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ åˆ°è²¨é»è²¨</h2>
  <div id="list"></div>

  <button onclick="submitArrival()">âœ… ç¢ºèªåˆ°è²¨</button>
  <button onclick="clearArrived()">ğŸ§¹ ä¸€éµæ¸…é™¤å·²åˆ°è²¨</button>

<script>
let userId = "";
let items = [];
let adminUserId = null; // ğŸ”´ æ–°å¢ï¼šå…¨åŸŸå„²å­˜ admin userId

async function init() {
  await liff.init({ liffId: "2008857998-ePcCkr6K" });
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  adminUserId = liff.getContext().userId; // ğŸ”´ æ–°å¢  
  }

  const profile = await liff.getProfile();
  userId = profile.userId;

  const res = await fetch(`/api/admin/arrival-list?userId=${userId}`);
  if (!res.ok) {
    alert("éç®¡ç†å“¡");
    liff.closeWindow();
    return;
  }

  items = await res.json();
  render();
}

function render() {
  const el = document.getElementById("list");
  el.innerHTML = items.map((i, idx) => `
    <div class="item">
      <label>
        <input type="checkbox" data-idx="${idx}">
        ${i.productName} / ${i.color} / ${i.size}
        ï¼ˆè¨‚è³¼ ${i.totalQty}ï¼‰
      </label>
      å¯¦åˆ°ï¼š
      <input type="number" min="0" value="${i.totalQty}" data-qty="${idx}">
    </div>
  `).join("");
}

async function submitArrival() {
  const selected = [];
  document.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (cb.checked) {
      const idx = cb.dataset.idx;
      const qty = document.querySelector(`input[data-qty="${idx}"]`).value;
      selected.push({ ...items[idx], arrivedQty: Number(qty) });
    }
  });

  if (!selected.length) {
    alert("è«‹å‹¾é¸é …ç›®");
    return;
  }

  await fetch("/api/admin/confirm", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, items: selected })
  });

  alert("åˆ°è²¨å®Œæˆ");
  location.reload();
}

async function clearArrived() {
  if (!confirm("ç¢ºå®šæ¸…é™¤å·²åˆ°è²¨é …ç›®ï¼Ÿ")) return;

  await fetch("/api/admin/clear", {
    method: "POST",
    headers: { "Content-Type": "application/json",
    "x-line-userid": adminUserId // ğŸ”´ æ–°å¢ï¼šadminAuth éœ€è¦   
     },
    body: JSON.stringify({ userId })
  });

  alert("å·²æ¸…é™¤");
  location.reload();
}

init();
</script>
</body>
</html>
