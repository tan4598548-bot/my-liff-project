<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç™¼è²¨åˆ—å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<h2>ğŸšš ç™¼è²¨ PDF</h2>
<div id="list"></div>
<button onclick="ship()">ğŸ“„ ç”¢ç”Ÿ PDF</button>

<script>
let userId = "";
let orders = [];
let adminUserId = null; // ğŸ”´ æ–°å¢ï¼šå…¨åŸŸå„²å­˜ admin userId

async function init() {
  await liff.init({ liffId: "2008857998-HUEXLkgO" });
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  adminUserId = liff.getContext().userId; // ğŸ”´ æ–°å¢  
  }

  const profile = await liff.getProfile();
  userId = profile.userId;

  const res = await fetch(`/api/admin/shipping-list?userId=${userId}`);
  if (!res.ok) {
    alert("éç®¡ç†å“¡");
    liff.closeWindow();
    return;
  }

  orders = await res.json();
  render();
}

function render() {
  const el = document.getElementById("list");
  el.innerHTML = orders.map(o => `
    <label>
      <input type="checkbox" value="${o.orderId}">
      ${o.buyerName} - ${o.productName} x ${o.qty}
    </label><br>
  `).join("");
}

async function ship() {
  const ids = [...document.querySelectorAll("input:checked")].map(i => i.value);
  if (!ids.length) return alert("è«‹é¸æ“‡è¨‚å–®");

  const res = await fetch("/api/admin/ship", {
    method: "POST",
    headers: { "Content-Type": "application/json",
  "x-line-userid": adminUserId // ğŸ”´ æ–°å¢ï¼šadminAuth éœ€è¦    
     },
    body: JSON.stringify({ userId, orderIds: ids })
  });

  const data = await res.json();
  window.open(data.pdfUrl, "_blank");
}

init();
</script>
</body>
</html>
